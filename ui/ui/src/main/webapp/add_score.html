<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>添加成绩</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>
<div id="overlay"></div> <!-- 添加遮罩层 -->
<div class="container">
    <h1 style="font-size: 18px; margin-bottom: 20px;">成绩管理</h1>

    <div class="action-bar">
        <button class="primary-btn">添加成绩</button>
    </div>

    <table class="data-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>学生姓名</th>
            <th>语文</th>
            <th>数学</th>
            <th>英语</th>
            <th>总分</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody id="scoreTableBody">
        <!-- 数据由JS动态填充 -->
        </tbody>
    </table>
    <div id="pagination" class="pagination"></div>
    <!-- 成绩管理模态框 -->
    <div id="scoreModal" class="modal">
        <h3 id="scoreModalTitle" class="modal-title">添加成绩</h3>
        <form id="scoreForm" class="modal-form">
            <input type="hidden" id="scoreId">
            <div class="form-group">
                <label>学生姓名:</label>
                <input type="text" id="studentName" required class="form-input">
            </div>
            <div class="form-group">
                <label>语文:</label>
                <input type="text" id="ChineseScore" required class="form-input"
                       placeholder="例：80">
            </div>
            <div class="form-group">
                <label>数学：</label>
                <input type="text" id="MathScore" required class="form-input"
                       placeholder="例：80">
            </div>
            <div class="form-group">
                <label>英语：</label>
                <input type="text" id="EnglishScore" required class="form-input"
                       placeholder="例：80">
            </div>
            <div class="form-actions">
                <button type="button" class="cancel-btn">取消</button>
                <button type="submit" class="submit-btn">保存</button>
            </div>
        </form>
    </div>
</div>
<script>
    $(document).ready(function() {
        // 关闭模态框
        window.closeScoreModal = function () {
            $('#scoreModal').hide();
            $overlay.hide();
        }

        let scores = [
            {
                sid: 1,
                name: "student1",
                chinese: "80",
                math: "80",
                english: "80"
            }
        ];

        let currentPage = 1;
        let totalPages = 1;
        let pagesize= 10;

        const $overlay = $('#overlay');

        // 绑定按钮点击事件
        $('body').on('click', '.primary-btn', function () {
            showScoreModal('add');
        })
        $(document).on('click', '.cancel-btn', closeScoreModal)
            .on('click', '[data-action="edit"]', function () {
                const ScoreId = $(this).data('id');
                showScoreModal('edit', ScoreId);
            })

        // 显示模态框
        window.showScoreModal = function (type, scoreId = null) {
            const $modal = $('#scoreModal');

            if (type === 'edit') {
                const score = scores.find(s => s.sid == scoreId);
                $('#scoreModalTitle').text('编辑成绩');
                $('#scoreId').val(score.sid);
                $('#studentName').val(score.name);
                $('#ChineseScore').val(score.chinese);
                $('#MathScore').val(score.math);
                $('#EnglishScore').val(score.english);
            } else {
                $('#scoreModalTitle').text('添加权限');
                $('#scoreForm')[0].reset();
                $('#scoreId').val('');
            }
            $modal.show();
            $overlay.show();
        }



        // 表单提交处理
        $('#scoreForm').on('submit', function (event) {
            event.preventDefault();
            const scoreData = {
                sid: $('#scoreId').val(),
                name: $('#studentName').val().trim(),
                role:{
                    role_id: 2,
                    role_name: '学生'
                },
                chinese: $('#ChineseScore').val().trim(),
                math: $('#MathScore').val().trim(),
                english: $('#EnglishScore').val().trim(),
            };
            scoreData.total = parseInt(scoreData.chinese) + parseInt(scoreData.math) + parseInt(scoreData.english);
            if (scoreData.sid) {
                $.ajax({
                    url: 'http://localhost:80/scorecontroller/updateScore',
                    method: 'POST',
                    dataType: 'json',
                    data: JSON.stringify(scoreData),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.code == 200) {
                            fecthScores();
                            closeScoreModal();
                            alert('修改成功')
                        }
                    }
                })
            } else {
                $.ajax({
                    url: 'http://localhost:80/scorecontroller/addScore',
                    method: 'POST',
                    dataType: 'json',
                    data: JSON.stringify(scoreData),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.code == 200) {
                            alert('添加成功')
                            fecthScores();
                            closeScoreModal();
                        }
                    },

                })

            }
        });

        // 删除权限
        $(document).on('click', '[data-action="delete"]', function () {
            const scoreId = $(this).data('id');
            if (confirm('确定要删除吗？')) {
                $.ajax({
                    url: 'http://localhost:80/scorecontroller/delScore',
                    method: 'POST',
                    dataType: 'json',
                    data: JSON.stringify(scoreId),
                    contentType: 'application/json',
                    success: function (response) {
                        if (response.code == 200) {
                            alert('删除成功')
                            fecthScores();
                        }
                    }
                })
            }

        })

        function fecthScores(page = currentPage) {
            currentPage = page;
            $.ajax({
                url: 'http://localhost:80/scorecontroller/findAllScore?currentpage='+currentPage+'&pagesize='+pagesize,
                method: 'GET',
                success: function (response) {
                    scores = response.data;
                    totalPages = Math.ceil(response.count/pagesize);
                    renderScoreTable();
                    renderPagination();
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        }
        // 分页
        function renderPagination() {
            const $pagination = $('#pagination').empty();

            // 添加首页按钮
            const $firstPage = $('<button>').text('首页').addClass('page-link');
            if (currentPage === 1) {
                $firstPage.prop('disabled', true);
            }
            $firstPage.on('click', function() {
                fecthScores(1);
            });
            $pagination.append($firstPage);

            // 添加上一页按钮
            const $prevPage = $('<button>').text('上一页').addClass('page-link');
            if (currentPage === 1) {
                $prevPage.prop('disabled', true);
            }
            $prevPage.on('click', function() {
                fecthScores(currentPage - 1);
            });
            $pagination.append($prevPage);

            if (totalPages > 0) {
                for (let i = 1; i <= totalPages; i++) {
                    const $pageLink = $('<button>').text(i).addClass('page-link');
                    if (i === currentPage) {
                        $pageLink.addClass('active');
                    }
                    $pageLink.on('click', function() {
                        fecthScores(i);
                    });
                    $pagination.append($pageLink);
                }
            }

            // 添加下一页按钮
            const $nextPage = $('<button>').text('下一页').addClass('page-link');
            if (currentPage === totalPages) {
                $nextPage.prop('disabled', true);
            }
            $nextPage.on('click', function() {
                fecthScores(currentPage + 1);
            });
            $pagination.append($nextPage);

            // 添加尾页按钮
            const $lastPage = $('<button>').text('尾页').addClass('page-link');
            if (currentPage === totalPages) {
                $lastPage.prop('disabled', true);
            }
            $lastPage.on('click', function() {
                fecthScores(totalPages);
            });
            $pagination.append($lastPage);
        }
        // 渲染表格
        function renderScoreTable() {
            const $sbody = $('#scoreTableBody').empty();
            $.each(scores, function (index, score) {
                $sbody.append(`
                        <tr>
                            <td>${score.sid}</td>
                            <td>${score.name}</td>
                            <td>${score.chinese}</td>
                            <td>${score.math}</td>
                            <td>${score.english}</td>
                            <td>${score.total}</td>
                            <td>
                                <button data-action="edit" data-id="${score.sid}">编辑</button>
                                <button data-action="delete" data-id="${score.sid}">删除</button>
                            </td>
                        </tr>
                    `);
            });
        }

        // 点击模态框外部关闭
        $(document).on('click', '#scoreModal', function (e) {
            if (e.target === this) closeScoreModal();
        });
        // 初始化渲染
        fecthScores();

    });
</script>
</body>
</html>